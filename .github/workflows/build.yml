name: "Build & Cache"

on:
  push:
    branches: [develop, main]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      NIXPKGS_ALLOW_UNFREE: 1

    steps:
      - uses: actions/checkout@v4

      # 1. Fix /mnt permissions (prevents crashes in runners using /mnt for temp)
      - name: Open permissions on /mnt
        run: sudo chmod 1777 /mnt

      # 2. Create the large /nix volume (100GB+)
      - name: Maximize Nix Space
        uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: "rampage"
          witness-carnage: true
          root-safe-haven: "10240"
          mnt-safe-haven: "2048"
          nix-permission-edict: false

      # 3. Configure environment: Use /tmp for safety, /nix/build for size
      - name: Configure Build Paths
        run: |
          set -euxo pipefail

          # Force TMPDIR back to /tmp (root FS) to avoid permission errors on /mnt or /nix
          echo "TMPDIR=/tmp" >> "$GITHUB_ENV"
          echo "TMP=/tmp" >> "$GITHUB_ENV"
          echo "TEMP=/tmp" >> "$GITHUB_ENV"

          # Prepare the heavy build directory on the large volume
          # Mode 1777 (like /tmp) ensures nixbld users can write to it
          sudo mkdir -p /nix/build
          sudo chmod 1777 /nix/build
          
      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            auto-optimise-store = true
            build-dir = /nix/build

      - uses: cachix/cachix-action@v15
        with:
          name: krit-nixos
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          skipPush: true

      - name: Build nixos-desktop
        run: |
          # Build and capture output path
          nix build --no-link --print-out-paths \
            .#nixosConfigurations.nixos-desktop.config.system.build.toplevel \
            | tee outpaths.txt

      - name: Push to Cachix
        run: |
          cachix push krit-nixos $(cat outpaths.txt)
