name: "Build & Cache"

on:
  push:
    branches: [develop, main]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      NIXPKGS_ALLOW_UNFREE: 1

    steps:
      - uses: actions/checkout@v4

      - name: Maximize Nix Space
        uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: "rampage"
          witness-carnage: true
          root-safe-haven: "10240"
          mnt-safe-haven: "2048"
          nix-permission-edict: false

      - name: Configure temp + caches to live on /nix (avoid /mnt permissions + small /)
        run: |
          set -euxo pipefail

          # Make sure temp is on /nix, not /mnt
          sudo mkdir -p /nix/tmp
          sudo chmod 1777 /nix/tmp

          # Build scratch space on /nix
          sudo mkdir -p /nix/build
          sudo chown -R "$(id -u)":"$(id -g)" /nix/build

          # Put user caches on /nix
          sudo mkdir -p /nix/xdg-cache/nix
          sudo chown -R "$(id -u)":"$(id -g)" /nix/xdg-cache

          # Put root caches on /nix (nix-daemon / root will write here)
          sudo mkdir -p /nix/xdg-cache/root-nix
          sudo chmod 0755 /nix/xdg-cache/root-nix

          # Export env for subsequent steps
          {
            echo "TMPDIR=/nix/tmp"
            echo "TMP=/nix/tmp"
            echo "TEMP=/nix/tmp"
            echo "TEMPDIR=/nix/tmp"
            echo "XDG_CACHE_HOME=/nix/xdg-cache"
          } >> "$GITHUB_ENV"

          # Symlink runner cache to /nix
          mkdir -p /home/runner/.cache
          rm -rf /home/runner/.cache/nix
          ln -s /nix/xdg-cache/nix /home/runner/.cache/nix

          # Symlink root cache to /nix
          sudo mkdir -p /root/.cache
          sudo rm -rf /root/.cache/nix
          sudo ln -s /nix/xdg-cache/root-nix /root/.cache/nix

          df -h / /mnt /nix
          echo "TMPDIR=$TMPDIR"
          echo "XDG_CACHE_HOME=$XDG_CACHE_HOME"

      - uses: cachix/install-nix-action@v31
        env:
          TMPDIR: /nix/tmp
          XDG_CACHE_HOME: /nix/xdg-cache
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            auto-optimise-store = true
            build-dir = /nix/build

      - uses: cachix/cachix-action@v15
        with:
          name: krit-nixos
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          skipPush: true

      - name: Build nixos-desktop (capture output path)
        env:
          TMPDIR: /nix/tmp
          XDG_CACHE_HOME: /nix/xdg-cache
        run: |
          set -euxo pipefail
          nix build --no-link --print-out-paths \
            .#nixosConfigurations.nixos-desktop.config.system.build.toplevel \
            | tee outpaths.txt

      - name: Push only the build output to Cachix
        env:
          TMPDIR: /nix/tmp
          XDG_CACHE_HOME: /nix/xdg-cache
        run: |
          set -euxo pipefail
          cachix push krit-nixos $(cat outpaths.txt)
