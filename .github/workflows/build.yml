name: "Build & Cache"

on:
  push:
    branches: [develop, main]
  pull_request:
  schedule:
    # Weekly on Fridays at 05:00 UTC
    - cron: '0 5 * * 5'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    env:
      NIXPKGS_ALLOW_UNFREE: 1

    steps:
      - uses: actions/checkout@v4

      # 1. FIX PERMISSIONS on /mnt
      - name: Open permissions on /mnt
        run: sudo chmod 1777 /mnt

      # 2. RECLAIM SPACE (Create /nix volume)
      - name: Maximize Nix Space
        uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: 'rampage'
          witness-carnage: true
          nix-permission-edict: false

      # 3. CONFIGURE PATHS
      - name: Prepare Build Paths
        run: |
          set -euxo pipefail

          # Safe temp dir on root disk
          echo "TMPDIR=/tmp" >> "$GITHUB_ENV"
          echo "TMP=/tmp" >> "$GITHUB_ENV"
          echo "TEMP=/tmp" >> "$GITHUB_ENV"

          # Heavy build dir on /nix
          # Must be 755 root:root (NOT 777) to satisfy Nix security checks
          sudo mkdir -p /nix/build
          sudo chmod 0755 /nix/build
          sudo chown root:root /nix/build


      # 4 Configure multi-platform builds
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 5. INSTALL NIX (DeterminateSystems)
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            build-dir = /nix/build
            
            auto-optimise-store = true
            experimental-features = nix-command flakes

      # 6. UPDATE FLAKE LOCK (Scheduled builds only)
      - name: Update Flake Lock
        if: github.event_name == 'schedule'
        run: nix flake update

      # 7. CACHIX
      - uses: cachix/cachix-action@v15
        with:
          name: krit-nixos
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          skipPush: true

      # 8. BUILD
      - name: Build All Configurations
        run: |
          # Build Desktop (x86)
          nix build .#nixosConfigurations.nixos-desktop.config.system.build.toplevel --no-link --print-out-paths >> outpaths.txt
          
          # Build Laptop (ARM)
          nix build .#nixosConfigurations.nixos-laptop.config.system.build.toplevel --no-link --print-out-paths >> outpaths.txt

      # 9. PUSH TO CACHIX
      - name: Push to Cachix
        run: |
          cachix push krit-nixos $(cat outpaths.txt)

      # 10. COMMIT FLAKE LOCK UPDATE (Scheduled builds only)
      - name: Commit Flake Update
        if: github.event_name == 'schedule'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add flake.lock
          git commit -m "chore: weekly flake update (automated)"
          git push origin develop
